<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>皮卡丘的音乐站 · Pikachu Music Station</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Particles -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    :root{
      --glass-bg: rgba(15, 18, 30, .55);
      --glass-bg-2: rgba(18, 22, 38, .65);
      --glass-border: rgba(255,255,255,.10);
      --text-dim: rgba(255,255,255,.70);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --neon: 0 0 18px rgba(120, 140, 255, .45), 0 0 32px rgba(255, 220, 80, .25);
    }

    html,body{ height:100%; }
    body{
      margin:0;
      color:white;
      overflow:hidden;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(130,90,255,.18), transparent 55%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(255,210,80,.14), transparent 60%),
                  radial-gradient(900px 700px at 60% 90%, rgba(80,220,255,.10), transparent 55%),
                  #070A12;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial;
    }

    /* particles background */
    #particles-js{
      position:fixed; inset:0;
      z-index:-2;
    }
    .bg-glow{
      position:fixed; inset:-200px;
      z-index:-3;
      filter: blur(80px);
      opacity:.6;
      background:
        radial-gradient(closest-side at 20% 25%, rgba(255, 220, 80, .30), transparent 65%),
        radial-gradient(closest-side at 70% 20%, rgba(140, 120, 255, .28), transparent 60%),
        radial-gradient(closest-side at 60% 80%, rgba(80, 220, 255, .18), transparent 60%);
    }

    /* glass card */
    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .glass2{
      background: var(--glass-bg-2);
      border: 1px solid var(--glass-border);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* custom select */
    select, option{
      color: white;
      background: rgba(15,18,30,.85);
    }
    select{
      border: 1px solid rgba(255,255,255,.14);
      outline: none;
    }
    select:focus{
      box-shadow: 0 0 0 3px rgba(120,140,255,.18);
      border-color: rgba(120,140,255,.35);
    }

    /* ripple */
    .ripple-wrap{ position:relative; overflow:hidden; }
    .ripple{
      position:absolute; border-radius:9999px;
      transform: scale(0);
      animation: ripple .55s ease-out;
      background: rgba(255,255,255,.22);
      pointer-events:none;
      mix-blend-mode: screen;
    }
    @keyframes ripple{
      to{ transform: scale(3.2); opacity:0; }
    }

    /* scrollbars */
    .nice-scroll::-webkit-scrollbar{ width:10px; }
    .nice-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,.05); border-radius:10px; }
    .nice-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius:10px; }
    .nice-scroll::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.26); }

    /* lyrics glow */
    .lyric-line{
      transition: transform .25s ease, opacity .25s ease, filter .25s ease;
      opacity:.60;
      filter: blur(.0px);
    }
    .lyric-line.active{
      opacity:1;
      transform: scale(1.02);
      text-shadow: var(--neon);
    }

    /* platform badges */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      font-size:.72rem;
      padding:.15rem .55rem;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
    }
    .b-migu{ box-shadow: 0 0 0 1px rgba(255,180,60,.15) inset; }
    .b-netease{ box-shadow: 0 0 0 1px rgba(255,80,80,.18) inset; }
    .b-qq{ box-shadow: 0 0 0 1px rgba(80,200,255,.18) inset; }
    .b-kuwo{ box-shadow: 0 0 0 1px rgba(255,220,80,.18) inset; }

    /* small animated pikachu */
    .pikachu{
      width: 46px; height:46px;
      position:relative;
      animation: floaty 2.2s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0) rotate(-2deg); }
      50%{ transform: translateY(-6px) rotate(2deg); }
    }
    .pika-face{
      position:absolute; inset:0;
      border-radius: 16px 16px 18px 18px;
      background: linear-gradient(180deg, rgba(255,235,120,.95), rgba(255,210,40,.92));
      border: 1px solid rgba(255,255,255,.18);
    }
    .pika-ear{
      position:absolute; width:14px; height:28px;
      background: linear-gradient(180deg, rgba(255,235,120,.95), rgba(255,210,40,.92));
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      top:-10px;
    }
    .pika-ear:after{
      content:"";
      position:absolute; left:1px; right:1px; top:0;
      height:10px; border-radius:8px;
      background: rgba(20,20,25,.88);
    }
    .ear-left{ left:6px; transform: rotate(-18deg); }
    .ear-right{ right:6px; transform: rotate(18deg); }
    .pika-eye{
      position:absolute; top:18px;
      width:6px; height:6px; border-radius:999px;
      background: rgba(25,25,30,.92);
    }
    .eye-left{ left:13px; }
    .eye-right{ right:13px; }
    .pika-cheek{
      position:absolute; top:25px;
      width:9px; height:9px; border-radius:999px;
      background: rgba(255,90,90,.70);
      filter: blur(.2px);
    }
    .cheek-left{ left:6px; }
    .cheek-right{ right:6px; }
    .pika-mouth{
      position:absolute; left:50%; top:26px;
      width:10px; height:6px;
      border-bottom: 2px solid rgba(25,25,30,.70);
      border-radius: 0 0 999px 999px;
      transform: translateX(-50%);
    }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; z-index:50;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .modal{
      width:min(760px, 92vw);
      max-height: 82vh;
      overflow:auto;
    }

    /* visualizer canvas */
    #viz{
      position:absolute; inset:0;
      opacity:.55;
      pointer-events:none;
      filter: blur(.0px);
      mix-blend-mode: screen;
    }

    /* toasts */
    .toast{
      position:fixed;
      bottom: 98px;
      left: 50%;
      transform: translateX(-50%);
      z-index:60;
      display:none;
    }
  </style>
</head>

<body>
  <div id="particles-js"></div>
  <div class="bg-glow"></div>

  <!-- Toast -->
  <div id="toast" class="toast glass2 px-4 py-2 rounded-xl text-sm">
    <i class="fa-solid fa-sparkles mr-2"></i><span id="toastText"></span>
  </div>

  <!-- Shortcuts Modal -->
  <div id="modalBackdrop" class="modal-backdrop items-center justify-center">
    <div class="modal glass2 rounded-2xl p-5 nice-scroll">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-keyboard text-yellow-300"></i>
          <div>
            <div class="font-semibold" id="ksTitle">快捷键</div>
            <div class="text-xs" style="color:var(--text-dim)" id="ksSub">让你摸鱼更丝滑</div>
          </div>
        </div>
        <button class="ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95" id="btnCloseModal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="grid md:grid-cols-2 gap-3 text-sm">
        <div class="glass rounded-xl p-3">
          <div class="font-semibold mb-2">播放控制</div>
          <div class="space-y-2" style="color:var(--text-dim)">
            <div><span class="badge">Space</span> 播放 / 暂停</div>
            <div><span class="badge">← / →</span> 快退 / 快进 5 秒</div>
            <div><span class="badge">↑ / ↓</span> 音量 + / -</div>
            <div><span class="badge">N</span> 下一首</div>
            <div><span class="badge">P</span> 上一首</div>
            <div><span class="badge">L</span> 切换歌词面板</div>
          </div>
        </div>

        <div class="glass rounded-xl p-3">
          <div class="font-semibold mb-2">效率操作</div>
          <div class="space-y-2" style="color:var(--text-dim)">
            <div><span class="badge">/</span> 聚焦搜索框</div>
            <div><span class="badge">F</span> 收藏 / 取消收藏当前歌</div>
            <div><span class="badge">S</span> 下载当前歌</div>
            <div><span class="badge">T</span> 中英文切换</div>
            <div><span class="badge">?</span> 打开本窗口</div>
          </div>
        </div>
      </div>

      <div class="mt-4 text-xs" style="color:var(--text-dim)">
        提示：快捷键在输入框聚焦时会自动避让（避免打字误触）。
      </div>
    </div>
  </div>

  <!-- Main layout -->
  <div class="h-screen w-screen p-4 md:p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="pikachu">
          <div class="pika-ear ear-left"></div>
          <div class="pika-ear ear-right"></div>
          <div class="pika-face"></div>
          <div class="pika-eye eye-left"></div>
          <div class="pika-eye eye-right"></div>
          <div class="pika-cheek cheek-left"></div>
          <div class="pika-cheek cheek-right"></div>
          <div class="pika-mouth"></div>
        </div>

        <div>
          <div class="text-lg md:text-xl font-semibold tracking-wide">
            <span class="text-yellow-300">皮卡丘的音乐站</span>
            <span class="text-xs md:text-sm ml-2" style="color:var(--text-dim)">Pikachu Music Station</span>
          </div>
          <div class="text-xs" style="color:var(--text-dim)">
            Author: Zhenchao Jin + Claude
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnShortcuts" class="ripple-wrap glass px-3 py-2 rounded-xl hover:opacity-95">
          <i class="fa-solid fa-keyboard mr-2 text-yellow-300"></i><span id="btnShortcutsText">快捷键</span>
        </button>
        <button id="btnLang" class="ripple-wrap glass px-3 py-2 rounded-xl hover:opacity-95">
          <i class="fa-solid fa-language mr-2"></i><span id="btnLangText">中文</span>
        </button>
      </div>
    </div>

    <!-- Grid -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 h-[calc(100vh-170px)]">

      <!-- Left: Search -->
      <div class="md:col-span-3 glass rounded-2xl p-4 flex flex-col min-h-0">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold" id="searchTitle">搜索</div>
          <div class="text-xs" style="color:var(--text-dim)" id="searchHint">下拉自动加载更多</div>
        </div>

        <div class="flex gap-2 mb-3">
          <input id="q"
            class="w-full px-3 py-2 rounded-xl bg-black/20 border border-white/10 outline-none focus:ring-2 focus:ring-indigo-400/30"
            placeholder="周杰伦 / Those Years ..."
          />
          <button id="btnSearch" class="ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>

        <div class="glass2 rounded-xl p-3 mb-3">
          <div class="text-xs mb-2" style="color:var(--text-dim)" id="sourcesTitle">音乐源</div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label class="flex items-center gap-2 select-none cursor-pointer">
              <input type="checkbox" id="src_migu" checked />
              <span class="badge b-migu"><i class="fa-solid fa-bolt text-orange-300"></i>咪咕</span>
            </label>
            <label class="flex items-center gap-2 select-none cursor-pointer">
              <input type="checkbox" id="src_netease" checked />
              <span class="badge b-netease"><i class="fa-solid fa-music text-red-300"></i>网易</span>
            </label>
            <label class="flex items-center gap-2 select-none cursor-pointer">
              <input type="checkbox" id="src_qq" checked />
              <span class="badge b-qq"><i class="fa-brands fa-qq text-cyan-300"></i>QQ</span>
            </label>
            <label class="flex items-center gap-2 select-none cursor-pointer">
              <input type="checkbox" id="src_kuwo" checked />
              <span class="badge b-kuwo"><i class="fa-solid fa-sun text-yellow-300"></i>酷我</span>
            </label>
          </div>

          <div class="mt-3 flex items-center justify-between gap-2">
            <div class="text-xs" style="color:var(--text-dim)" id="perSourceTitle">每源数量</div>
            <select id="perSource" class="px-3 py-2 rounded-xl w-28 bg-black/20">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="30">30</option>
              <option value="40">40</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold" id="resultsTitle">结果</div>
          <div class="text-xs" style="color:var(--text-dim)" id="resultsCount">0</div>
        </div>

        <div id="results" class="nice-scroll flex-1 min-h-0 overflow-auto rounded-xl">
          <!-- results list -->
        </div>

        <div class="mt-2 text-xs" style="color:var(--text-dim)" id="moreHint"></div>
      </div>

      <!-- Center: Player + Lyrics -->
      <div class="md:col-span-6 glass rounded-2xl p-4 flex flex-col min-h-0 relative">
        <canvas id="viz"></canvas>

        <div class="flex items-start justify-between gap-3 mb-3">
          <div class="flex items-center gap-3">
            <img id="cover" class="w-16 h-16 rounded-2xl object-cover border border-white/10"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='100%25' height='100%25' fill='%2310172c'/%3E%3Ctext x='50%25' y='52%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' opacity='.55' font-size='20'%3EPIKA%3C/text%3E%3C/svg%3E"/>
            <div>
              <div id="nowTitle" class="text-lg font-semibold leading-tight">—</div>
              <div id="nowArtist" class="text-sm" style="color:var(--text-dim)">—</div>
              <div class="mt-1 flex items-center gap-2">
                <span id="nowBadge" class="badge"><i class="fa-solid fa-star text-yellow-300"></i><span id="nowSrc">—</span></span>
                <button id="btnFav" class="ripple-wrap glass px-3 py-1.5 rounded-xl text-sm hover:opacity-95">
                  <i class="fa-regular fa-heart mr-2"></i><span id="favText">收藏</span>
                </button>
                <button id="btnDownload" class="ripple-wrap glass px-3 py-1.5 rounded-xl text-sm hover:opacity-95">
                  <i class="fa-solid fa-download mr-2"></i><span id="dlText">下载</span>
                </button>
              </div>
            </div>
          </div>

          <button id="btnToggleLyrics" class="ripple-wrap glass px-3 py-2 rounded-xl hover:opacity-95">
            <i class="fa-solid fa-wand-magic-sparkles mr-2 text-indigo-300"></i><span id="lyricsBtnText">歌词</span>
          </button>
        </div>

        <!-- Lyrics -->
        <div id="lyricsPanel" class="glass2 rounded-2xl p-4 flex-1 min-h-0 overflow-auto nice-scroll">
          <div id="lyrics" class="space-y-3 text-center leading-relaxed">
            <div class="text-sm" style="color:var(--text-dim)" id="lyricsEmpty">搜索并播放一首歌吧 ✨</div>
          </div>
        </div>
      </div>

      <!-- Right: Queue / Favorites / Playlists -->
      <div class="md:col-span-3 glass rounded-2xl p-4 flex flex-col min-h-0">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold" id="listTitle">播放列表</div>
          <div class="flex items-center gap-2">
            <button id="tabQueue" class="ripple-wrap px-3 py-2 rounded-xl glass2 hover:opacity-95 text-sm">
              <i class="fa-solid fa-list mr-2"></i><span id="tabQueueText">搜索队列</span>
            </button>
            <button id="tabFav" class="ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95 text-sm">
              <i class="fa-solid fa-heart mr-2 text-pink-300"></i><span id="tabFavText">收藏</span>
            </button>
          </div>
        </div>

        <div class="glass2 rounded-xl p-3 mb-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold" id="playlistTitle">歌单</div>
            <button id="btnNewPlaylist" class="ripple-wrap glass px-3 py-2 rounded-xl text-sm hover:opacity-95">
              <i class="fa-solid fa-plus mr-2"></i><span id="newPlText">新建</span>
            </button>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <select id="playlistSelect" class="px-3 py-2 rounded-xl w-full bg-black/20">
              <option value="__none__">（未选择）</option>
            </select>
            <button id="btnAddToPlaylist" class="ripple-wrap glass px-3 py-2 rounded-xl hover:opacity-95" title="添加当前歌到歌单">
              <i class="fa-solid fa-folder-plus"></i>
            </button>
          </div>
          <div class="mt-2 text-xs" style="color:var(--text-dim)" id="playlistHint">同一歌单内不重复</div>
        </div>

        <div id="rightList" class="nice-scroll flex-1 min-h-0 overflow-auto rounded-xl">
          <!-- queue/fav -->
        </div>
      </div>
    </div>

    <!-- Bottom Player -->
    <div class="mt-4 glass rounded-2xl px-4 py-3 flex items-center gap-3">
      <button id="btnPrev" class="ripple-wrap glass2 px-3 py-2 rounded-xl hover:opacity-95">
        <i class="fa-solid fa-backward-step"></i>
      </button>
      <button id="btnPlay" class="ripple-wrap glass2 px-4 py-2 rounded-xl hover:opacity-95">
        <i id="playIcon" class="fa-solid fa-play"></i>
      </button>
      <button id="btnNext" class="ripple-wrap glass2 px-3 py-2 rounded-xl hover:opacity-95">
        <i class="fa-solid fa-forward-step"></i>
      </button>

      <div class="flex-1">
        <div class="flex items-center justify-between text-xs mb-1" style="color:var(--text-dim)">
          <span id="tCur">0:00</span>
          <span id="tDur">0:00</span>
        </div>
        <input id="seek" type="range" min="0" max="1000" value="0"
               class="w-full accent-indigo-300"/>
      </div>

      <div class="flex items-center gap-2 w-44">
        <i class="fa-solid fa-volume-low" style="color:var(--text-dim)"></i>
        <input id="vol" type="range" min="0" max="100" value="75" class="w-full accent-yellow-300"/>
      </div>

      <audio id="audio" crossorigin="anonymous"></audio>
    </div>

    <div class="mt-2 text-xs" style="color:var(--text-dim)">
      <span id="footerTip">提示：左侧结果列表下拉到底会自动加载更多（每源 +10）。</span>
    </div>
  </div>

<script>
/** =========================
 *  i18n
 *  ========================= */
const I18N = {
  zh: {
    shortcuts: "快捷键",
    shortcutsSub: "让你摸鱼更丝滑",
    search: "搜索",
    searchHint: "下拉自动加载更多",
    sources: "音乐源",
    perSource: "每源数量",
    results: "结果",
    queue: "播放列表",
    tabQueue: "搜索队列",
    tabFav: "收藏",
    playlist: "歌单",
    new: "新建",
    playlistHint: "同一歌单内不重复",
    lyrics: "歌词",
    fav: "收藏",
    unfav: "已收藏",
    download: "下载",
    emptyLyrics: "搜索并播放一首歌吧 ✨",
    noMore: "已经到头了：没有更多新结果了",
    loadedMore: "已加载更多：每源 +10",
    needPlay: "先播放一首歌再操作哦",
    addedFav: "已加入收藏",
    removedFav: "已取消收藏",
    addedPlaylist: "已加入歌单",
    existsPlaylist: "歌单里已经有这首了",
    createdPlaylist: "已创建歌单：",
    selectPlaylist: "请选择一个歌单",
    langBtn: "中文",
    tip: "提示：左侧结果列表下拉到底会自动加载更多（每源 +10）。",
  },
  en: {
    shortcuts: "Shortcuts",
    shortcutsSub: "Make your chill time smoother",
    search: "Search",
    searchHint: "Scroll down to auto-load more",
    sources: "Sources",
    perSource: "Per-source",
    results: "Results",
    queue: "Playlist",
    tabQueue: "Search Queue",
    tabFav: "Favorites",
    playlist: "Playlists",
    new: "New",
    playlistHint: "No duplicates in the same list",
    lyrics: "Lyrics",
    fav: "Fav",
    unfav: "Faved",
    download: "Download",
    emptyLyrics: "Search & play a song ✨",
    noMore: "No more new results",
    loadedMore: "Loaded more: +10 per source",
    needPlay: "Play a song first",
    addedFav: "Added to favorites",
    removedFav: "Removed from favorites",
    addedPlaylist: "Added to playlist",
    existsPlaylist: "Already in playlist",
    createdPlaylist: "Playlist created: ",
    selectPlaylist: "Select a playlist",
    langBtn: "EN",
    tip: "Tip: Scroll the left results list to bottom to auto-load more (+10 per source).",
  }
};
let LANG = "zh";
function t(key){ return I18N[LANG][key] ?? key; }
function applyI18n(){
  document.getElementById("btnShortcutsText").textContent = t("shortcuts");
  document.getElementById("ksTitle").textContent = t("shortcuts");
  document.getElementById("ksSub").textContent = t("shortcutsSub");
  document.getElementById("searchTitle").textContent = t("search");
  document.getElementById("searchHint").textContent = t("searchHint");
  document.getElementById("sourcesTitle").textContent = t("sources");
  document.getElementById("perSourceTitle").textContent = t("perSource");
  document.getElementById("resultsTitle").textContent = t("results");
  document.getElementById("listTitle").textContent = t("queue");
  document.getElementById("tabQueueText").textContent = t("tabQueue");
  document.getElementById("tabFavText").textContent = t("tabFav");
  document.getElementById("playlistTitle").textContent = t("playlist");
  document.getElementById("newPlText").textContent = t("new");
  document.getElementById("playlistHint").textContent = t("playlistHint");
  document.getElementById("lyricsBtnText").textContent = t("lyrics");
  document.getElementById("favText").textContent = isCurrentFav() ? t("unfav") : t("fav");
  document.getElementById("dlText").textContent = t("download");
  document.getElementById("lyricsEmpty").textContent = t("emptyLyrics");
  document.getElementById("btnLangText").textContent = t("langBtn");
  document.getElementById("footerTip").textContent = t("tip");
}

/** =========================
 *  Ripple
 *  ========================= */
function attachRipple(root=document){
  root.querySelectorAll(".ripple-wrap").forEach(el=>{
    el.addEventListener("click",(e)=>{
      const r = document.createElement("span");
      r.className="ripple";
      const rect = el.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height) * 1.2;
      r.style.width = r.style.height = size + "px";
      r.style.left = (e.clientX - rect.left - size/2) + "px";
      r.style.top  = (e.clientY - rect.top  - size/2) + "px";
      el.appendChild(r);
      setTimeout(()=>r.remove(), 600);
    }, {passive:true});
  });
}

/** =========================
 *  Toast
 *  ========================= */
let toastTimer=null;
function toast(msg){
  const box = document.getElementById("toast");
  document.getElementById("toastText").textContent = msg;
  box.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>box.style.display="none", 1800);
}

/** =========================
 *  Particles
 *  ========================= */
particlesJS("particles-js",{
  particles:{
    number:{ value: 80, density:{ enable:true, value_area: 900 } },
    color:{ value:["#a78bfa","#facc15","#22d3ee","#fb7185"] },
    shape:{ type:"circle" },
    opacity:{ value:.45, random:true },
    size:{ value: 2.4, random:true },
    line_linked:{ enable:true, distance: 140, color:"#a78bfa", opacity:.14, width:1 },
    move:{ enable:true, speed: 1.0 }
  },
  interactivity:{
    events:{
      onhover:{ enable:true, mode:"grab" },
      onclick:{ enable:true, mode:"push" }
    },
    modes:{
      grab:{ distance: 180, line_linked:{ opacity:.22 } },
      push:{ particles_nb: 2 }
    }
  },
  retina_detect:true
});

/** =========================
 *  Providers & APIs
 *  ========================= */
const API = {
  migu: {
    search: (kw, limit)=>`https://api-v1.cenguigui.cn/api/music/mgmusic_lingsheng.php?msg=${encodeURIComponent(kw)}&limit=${limit}&n=`,
    play:   (kw, n)=>`https://api-v1.cenguigui.cn/api/mg_music/?msg=${encodeURIComponent(kw)}&n=${n}&type=json&br=1`,
  },
  netease: {
    search: (kw, limit)=>`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=${encodeURIComponent(kw)}&num=${limit}&n=`,
    play:   (songid)=>`https://api.cenguigui.cn/api/netease/music_v1.php?id=${encodeURIComponent(songid)}&type=json&level=lossless`,
  },
  sayqz: {
    search: (kw, source, limit)=>`https://music-dl.sayqz.com/api?&type=search&keyword=${encodeURIComponent(kw)}&source=${source}&limit=${limit}`,
    // result.url is api url: https://music-dl.sayqz.com/api/?source=xxx&id=xxx&type=url
  }
};

const SRC_META = {
  migu:   { key:"migu",   name:{zh:"咪咕",en:"Migu"},   icon:"fa-bolt",      badgeClass:"b-migu"   },
  netease:{ key:"netease",name:{zh:"网易",en:"Netease"},icon:"fa-music",     badgeClass:"b-netease"},
  qq:     { key:"qq",     name:{zh:"QQ",en:"QQ"},       icon:"fa-qq",        badgeClass:"b-qq"     },
  kuwo:   { key:"kuwo",   name:{zh:"酷我",en:"Kuwo"},   icon:"fa-sun",       badgeClass:"b-kuwo"   },
};

/** =========================
 *  State
 *  ========================= */
let activeTab = "queue"; // queue | fav
let resultsInterleaved = []; // left list (interleaved)
let resultsBySource = { migu:[], netease:[], qq:[], kuwo:[] }; // raw
let seenBySource = { migu:new Set(), netease:new Set(), qq:new Set(), kuwo:new Set() }; // dedupe only within source
let perSourceLimit = 10;

let queue = [];      // current queue = resultsInterleaved snapshot
let favorites = [];  // persisted
let playlists = {};  // name -> array

let current = null;  // currently playing track object
let currentIndex = -1;

const audio = document.getElementById("audio");

/** =========================
 *  Persistence
 *  ========================= */
const LS = {
  fav: "pika_music_favorites_v2",
  playlists: "pika_music_playlists_v2",
};
function loadPersist(){
  try{
    favorites = JSON.parse(localStorage.getItem(LS.fav) || "[]");
    playlists = JSON.parse(localStorage.getItem(LS.playlists) || "{}");
  }catch{
    favorites=[];
    playlists={};
  }
  refreshPlaylistSelect();
  renderRightList();
}
function savePersist(){
  localStorage.setItem(LS.fav, JSON.stringify(favorites));
  localStorage.setItem(LS.playlists, JSON.stringify(playlists));
}

/** =========================
 *  Utils
 *  ========================= */
function fmtTime(sec){
  if(!isFinite(sec)) return "0:00";
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function enabledSources(){
  const en=[];
  if(document.getElementById("src_migu").checked) en.push("migu");
  if(document.getElementById("src_netease").checked) en.push("netease");
  if(document.getElementById("src_qq").checked) en.push("qq");
  if(document.getElementById("src_kuwo").checked) en.push("kuwo");
  return en;
}
function trackKeyWithinSource(src, item){
  // within-source unique key (not cross-platform)
  if(src==="netease") return `netease:${item.songid}`;
  if(src==="qq" || src==="kuwo") return `${src}:${item.id}`;
  if(src==="migu") return `migu:${item.n}:${item.title}:${item.singer}`;
  return `${src}:${item.title}:${item.singer}`;
}
function platformLabel(src){
  const m = SRC_META[src];
  return (LANG==="zh") ? m.name.zh : m.name.en;
}
function platformBadgeHtml(src){
  const m = SRC_META[src];
  const icon = (src==="qq") ? "fa-brands fa-qq" : `fa-solid ${m.icon}`;
  return `<span class="badge ${m.badgeClass}"><i class="${icon}"></i>${platformLabel(src)}</span>`;
}

/** =========================
 *  Fetch helpers
 *  ========================= */
async function safeJson(url){
  const r = await fetch(url, { cache:"no-store" });
  const ct = (r.headers.get("content-type")||"").toLowerCase();
  if(ct.includes("application/json") || ct.includes("text/json")){
    return await r.json();
  }
  // fallback try parse json
  const txt = await r.text();
  try{ return JSON.parse(txt); }catch{ return { __raw: txt }; }
}

/**
 * Core fix for: Kuwo/QQ url endpoint sometimes returns JSON/text/redirect.
 * Return a playable direct URL as best as possible.
 */
async function resolvePlayableUrl(maybeApiUrl){
  // If already looks like a media file, keep.
  if(typeof maybeApiUrl !== "string") return "";
  let url = maybeApiUrl.trim();
  if(!url) return "";

  // Fix mixed content: if page is https, upgrade http
  if(location.protocol === "https:" && url.startsWith("http://")){
    url = "https://" + url.slice("http://".length);
  }

  // try to fetch and interpret
  try{
    const r = await fetch(url, { redirect:"follow", cache:"no-store" });
    const ct = (r.headers.get("content-type")||"").toLowerCase();

    // if redirect chain ends at media
    const finalUrl = r.url || url;

    if(ct.includes("audio/") || ct.includes("video/")){
      return finalUrl;
    }
    if(ct.includes("application/json") || ct.includes("text/json")){
      const j = await r.json();
      // common patterns
      const candidate = j?.data?.url || j?.url || j?.data || "";
      if(typeof candidate === "string" && candidate) return resolvePlayableUrl(candidate);
      return finalUrl;
    }
    // if plain text: treat it as url
    const txt = await r.text();
    const maybe = txt.trim();
    if(maybe.startsWith("http://") || maybe.startsWith("https://")){
      return resolvePlayableUrl(maybe);
    }
    // otherwise fallback to finalUrl
    return finalUrl;
  }catch(e){
    return url; // last resort
  }
}

/** =========================
 *  Search + Interleave
 *  ========================= */
function interleaveResults(enabled){
  // round-robin merge by source order
  const pools = enabled.map(src => ({ src, arr: resultsBySource[src] || [], i:0 }));
  const merged = [];
  let progressed = true;
  while(progressed){
    progressed = false;
    for(const p of pools){
      if(p.i < p.arr.length){
        merged.push({ src: p.src, ...p.arr[p.i] });
        p.i++;
        progressed = true;
      }
    }
  }
  return merged;
}

async function doSearch(reset=true){
  const kw = document.getElementById("q").value.trim();
  if(!kw) return;
  perSourceLimit = parseInt(document.getElementById("perSource").value, 10) || 10;

  if(reset){
    resultsInterleaved = [];
    resultsBySource = { migu:[], netease:[], qq:[], kuwo:[] };
    seenBySource = { migu:new Set(), netease:new Set(), qq:new Set(), kuwo:new Set() };
    document.getElementById("moreHint").textContent = "";
  }

  const en = enabledSources();
  const promises = en.map(async (src)=>{
    if(src==="migu"){
      const j = await safeJson(API.migu.search(kw, perSourceLimit));
      const arr = (j && j.code===200 && Array.isArray(j.data)) ? j.data : [];
      for(const it of arr){
        const k = trackKeyWithinSource("migu", it);
        if(!seenBySource.migu.has(k)){
          seenBySource.migu.add(k);
          resultsBySource.migu.push({ title: it.title, singer: it.singer, n: it.n, kw, _k:k });
        }
      }
    }else if(src==="netease"){
      const j = await safeJson(API.netease.search(kw, perSourceLimit));
      const arr = (j && j.code===200 && Array.isArray(j.data)) ? j.data : [];
      for(const it of arr){
        const k = trackKeyWithinSource("netease", it);
        if(!seenBySource.netease.has(k)){
          seenBySource.netease.add(k);
          resultsBySource.netease.push({ title: it.title, singer: it.singer, songid: it.songid, kw, _k:k });
        }
      }
    }else if(src==="qq" || src==="kuwo"){
      const j = await safeJson(API.sayqz.search(kw, src, perSourceLimit));
      const arr = j?.data?.results || [];
      for(const it of arr){
        const k = trackKeyWithinSource(src, it);
        if(!seenBySource[src].has(k)){
          seenBySource[src].add(k);
          resultsBySource[src].push({
            title: it.name,
            singer: it.artist,
            album: it.album,
            id: it.id,
            url: it.url,   // api endpoint for playable url
            pic: it.pic,
            lrc: it.lrc,
            platform: it.platform,
            kw,
            _k:k
          });
        }
      }
    }
  });

  await Promise.allSettled(promises);

  resultsInterleaved = interleaveResults(en);
  queue = resultsInterleaved.slice(); // queue mirrors current results
  renderLeftResults();
  renderRightList();

  document.getElementById("resultsCount").textContent = String(resultsInterleaved.length);
}

/** =========================
 *  Rendering
 *  ========================= */
function renderLeftResults(){
  const box = document.getElementById("results");
  box.innerHTML = "";

  resultsInterleaved.forEach((it, idx)=>{
    const src = it.src;
    const title = it.title || "-";
    const singer = it.singer || "-";

    const row = document.createElement("div");
    row.className = "ripple-wrap glass2 rounded-xl p-3 mb-2 cursor-pointer hover:opacity-95";
    row.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${title}</div>
          <div class="text-xs truncate mt-0.5" style="color:var(--text-dim)">${singer}</div>
          <div class="mt-2">${platformBadgeHtml(src)}</div>
        </div>
        <div class="text-xs" style="color:var(--text-dim)">#${idx+1}</div>
      </div>
    `;
    row.addEventListener("click", ()=> playFromQueue(idx));
    box.appendChild(row);
  });

  attachRipple(box);
}

function renderRightList(){
  const box = document.getElementById("rightList");
  box.innerHTML = "";
  const list = (activeTab==="queue") ? queue : favorites;

  if(list.length===0){
    const empty = document.createElement("div");
    empty.className = "glass2 rounded-xl p-4 text-sm";
    empty.style.color = "var(--text-dim)";
    empty.innerHTML = activeTab==="queue"
      ? (LANG==="zh" ? "这里会显示搜索队列（左侧结果）" : "Search queue will show here")
      : (LANG==="zh" ? "还没有收藏，按 F 或点 ❤️ 收藏" : "No favorites yet. Press F or click ❤️");
    box.appendChild(empty);
    return;
  }

  list.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "ripple-wrap glass2 rounded-xl p-3 mb-2 cursor-pointer hover:opacity-95";
    row.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-semibold truncate">${it.title}</div>
          <div class="text-xs truncate mt-0.5" style="color:var(--text-dim)">${it.singer}</div>
          <div class="mt-2">${platformBadgeHtml(it.src)}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="glass px-2 py-1 rounded-lg text-xs hover:opacity-95" title="Play">
            <i class="fa-solid fa-play"></i>
          </button>
        </div>
      </div>
    `;
    row.addEventListener("click", ()=>{
      if(activeTab==="queue"){
        playFromQueue(idx);
      }else{
        // playing favorite: map into queue temporarily
        queue = favorites.slice();
        activeTab = "queue";
        document.getElementById("tabQueue").className = "ripple-wrap px-3 py-2 rounded-xl glass2 hover:opacity-95 text-sm";
        document.getElementById("tabFav").className   = "ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95 text-sm";
        renderRightList();
        playFromQueue(idx);
      }
    });
    box.appendChild(row);
  });

  attachRipple(box);
}

function refreshPlaylistSelect(){
  const sel = document.getElementById("playlistSelect");
  const old = sel.value;
  sel.innerHTML = `<option value="__none__">${LANG==="zh"?"（未选择）":"(None)"}</option>`;
  Object.keys(playlists).sort().forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name + ` (${playlists[name].length})`;
    sel.appendChild(opt);
  });
  if(old && [...sel.options].some(o=>o.value===old)) sel.value = old;
}

/** =========================
 *  Play logic (per source)
 *  ========================= */
async function fetchTrackDetail(track){
  const src = track.src;

  if(src==="migu"){
    const j = await safeJson(API.migu.play(track.kw, track.n));
    const d = j?.data || {};
    // Fix mixed content & resolve playable
    const cover = d.cover || "";
    const musicUrl = await resolvePlayableUrl(d.music_url || "");
    const lrcUrl = d.lrc_url || "";
    return {
      ...track,
      cover,
      rawMusicUrl: d.music_url || "",
      musicUrl,
      lrcUrl,
      lyricText: "", // migu returns lrc url
    };
  }

  if(src==="netease"){
    const j = await safeJson(API.netease.play(track.songid));
    const d = j?.data || {};
    const musicUrl = await resolvePlayableUrl(d.url || "");
    return {
      ...track,
      cover: d.pic || "",
      musicUrl,
      lyricText: d.lyric || "",
    };
  }

  if(src==="qq" || src==="kuwo"){
    const musicUrl = await resolvePlayableUrl(track.url || "");
    // lyrics endpoint also may need resolve -> fetch text
    let lyricText = "";
    try{
      const lrcUrl = track.lrc ? await resolvePlayableUrl(track.lrc) : "";
      if(lrcUrl){
        const r = await fetch(lrcUrl, { cache:"no-store" });
        lyricText = await r.text();
      }
    }catch{}
    // cover pic endpoint may return image directly; use as is
    return {
      ...track,
      cover: track.pic || "",
      musicUrl,
      lyricText,
    };
  }

  return track;
}

async function playFromQueue(idx){
  if(idx<0 || idx>=queue.length) return;
  currentIndex = idx;
  const base = queue[idx];
  current = await fetchTrackDetail(base);

  // Update UI header
  document.getElementById("nowTitle").textContent = current.title || "—";
  document.getElementById("nowArtist").textContent = current.singer || "—";
  document.getElementById("nowSrc").textContent = platformLabel(current.src);
  document.getElementById("nowBadge").className = `badge ${SRC_META[current.src].badgeClass}`;

  // cover
  if(current.cover){
    document.getElementById("cover").src = current.cover;
  }

  // fav button
  updateFavButton();

  // lyrics
  renderLyrics(current.lyricText || "", current.lrcUrl || "");

  // set audio
  if(!current.musicUrl){
    toast("获取播放链接失败（可能是接口临时波动）");
    return;
  }
  audio.src = current.musicUrl;
  await audio.play().catch(()=>{});
  document.getElementById("playIcon").className = "fa-solid fa-pause";
  toast(`${platformLabel(current.src)} · ${current.title}`);
}

/** =========================
 *  Lyrics
 *  ========================= */
function parseLrc(lrcText){
  // return [{t:seconds, text}]
  const lines = lrcText.split(/\r?\n/);
  const out=[];
  const timeRe = /\[(\d{2}):(\d{2})(?:\.(\d{1,3}))?\]/g;
  for(const line of lines){
    let m;
    const text = line.replace(timeRe,"").trim();
    while((m = timeRe.exec(line)) !== null){
      const mm = parseInt(m[1],10);
      const ss = parseInt(m[2],10);
      const ms = m[3] ? parseInt(m[3].padEnd(3,"0"),10) : 0;
      const t = mm*60 + ss + ms/1000;
      out.push({ t, text: text || "…" });
    }
  }
  out.sort((a,b)=>a.t-b.t);
  return out;
}

let lyricItems = [];
let lyricTimer = null;

async function renderLyrics(lyricText, lrcUrl){
  const box = document.getElementById("lyrics");
  lyricItems = [];
  box.innerHTML = "";

  if(!lyricText && lrcUrl){
    try{
      const r = await fetch(lrcUrl, { cache:"no-store" });
      lyricText = await r.text();
    }catch{}
  }

  if(!lyricText){
    box.innerHTML = `<div class="text-sm" style="color:var(--text-dim)">${t("emptyLyrics")}</div>`;
    return;
  }

  lyricItems = parseLrc(lyricText);
  if(lyricItems.length===0){
    box.innerHTML = `<div class="text-sm" style="color:var(--text-dim)">${lyricText.slice(0,300)}</div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  lyricItems.forEach((it)=>{
    const div = document.createElement("div");
    div.className = "lyric-line text-base md:text-lg";
    div.textContent = it.text;
    frag.appendChild(div);
  });
  box.appendChild(frag);
}

/** highlight lyric line by current time */
function updateLyricsHighlight(){
  if(!lyricItems.length) return;
  const tcur = audio.currentTime || 0;
  let idx = 0;
  for(let i=0;i<lyricItems.length;i++){
    if(lyricItems[i].t <= tcur) idx = i;
    else break;
  }
  const lines = document.querySelectorAll("#lyrics .lyric-line");
  lines.forEach((el,i)=>{
    if(i===idx) el.classList.add("active");
    else el.classList.remove("active");
  });

  // smooth scroll to active line
  const active = lines[idx];
  if(active){
    active.scrollIntoView({ block:"center", behavior:"smooth" });
  }
}

/** =========================
 *  Favorites / playlists
 *  ========================= */
function isSameTrack(a,b){
  // same within same src by stable key
  if(!a || !b) return false;
  if(a.src !== b.src) return false;
  if(a.src==="netease") return a.songid===b.songid;
  if(a.src==="qq"||a.src==="kuwo") return a.id===b.id;
  if(a.src==="migu") return (a.n===b.n && a.kw===b.kw && a.title===b.title && a.singer===b.singer);
  return a.title===b.title && a.singer===b.singer;
}

function isCurrentFav(){
  if(!current) return false;
  return favorites.some(x=>isSameTrack(x,current));
}
function updateFavButton(){
  const btn = document.getElementById("btnFav");
  const icon = btn.querySelector("i");
  const f = isCurrentFav();
  icon.className = f ? "fa-solid fa-heart mr-2 text-pink-300" : "fa-regular fa-heart mr-2";
  document.getElementById("favText").textContent = f ? t("unfav") : t("fav");
}

function toggleFav(){
  if(!current){ toast(t("needPlay")); return; }
  const idx = favorites.findIndex(x=>isSameTrack(x,current));
  if(idx>=0){
    favorites.splice(idx,1);
    toast(t("removedFav"));
  }else{
    favorites.unshift(current);
    toast(t("addedFav"));
  }
  savePersist();
  updateFavButton();
  if(activeTab==="fav") renderRightList();
}

function createPlaylist(){
  const name = prompt(LANG==="zh" ? "输入歌单名称：" : "Playlist name:");
  if(!name) return;
  if(!playlists[name]) playlists[name] = [];
  savePersist();
  refreshPlaylistSelect();
  toast(t("createdPlaylist") + name);
}

function addCurrentToPlaylist(){
  if(!current){ toast(t("needPlay")); return; }
  const sel = document.getElementById("playlistSelect");
  const name = sel.value;
  if(!name || name==="__none__"){ toast(t("selectPlaylist")); return; }
  const arr = playlists[name] || (playlists[name]=[]);
  if(arr.some(x=>isSameTrack(x,current))){
    toast(t("existsPlaylist"));
    return;
  }
  arr.unshift(current);
  savePersist();
  refreshPlaylistSelect();
  toast(t("addedPlaylist"));
}

/** =========================
 *  Tabs
 *  ========================= */
function setTab(tab){
  activeTab = tab;
  if(tab==="queue"){
    document.getElementById("tabQueue").className = "ripple-wrap px-3 py-2 rounded-xl glass2 hover:opacity-95 text-sm";
    document.getElementById("tabFav").className   = "ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95 text-sm";
  }else{
    document.getElementById("tabQueue").className = "ripple-wrap px-3 py-2 rounded-xl glass hover:opacity-95 text-sm";
    document.getElementById("tabFav").className   = "ripple-wrap px-3 py-2 rounded-xl glass2 hover:opacity-95 text-sm";
  }
  renderRightList();
}

/** =========================
 *  Infinite scroll (left results)
 *  ========================= */
let loadingMore = false;
async function loadMore(){
  if(loadingMore) return;
  loadingMore = true;

  const before = resultsInterleaved.length;
  perSourceLimit += 10;
  document.getElementById("perSource").value = String(perSourceLimit);

  await doSearch(false);
  const after = resultsInterleaved.length;

  if(after<=before){
    document.getElementById("moreHint").textContent = t("noMore");
    toast(t("noMore"));
  }else{
    document.getElementById("moreHint").textContent = t("loadedMore");
    toast(t("loadedMore"));
  }
  loadingMore = false;
}

/** =========================
 *  Player controls + seek + volume
 *  ========================= */
function playPause(){
  if(!audio.src){
    if(queue.length>0) playFromQueue(0);
    return;
  }
  if(audio.paused){
    audio.play().catch(()=>{});
    document.getElementById("playIcon").className = "fa-solid fa-pause";
  }else{
    audio.pause();
    document.getElementById("playIcon").className = "fa-solid fa-play";
  }
}
function nextTrack(){
  if(queue.length===0) return;
  const ni = Math.min(queue.length-1, currentIndex+1);
  playFromQueue(ni);
}
function prevTrack(){
  if(queue.length===0) return;
  const pi = Math.max(0, currentIndex-1);
  playFromQueue(pi);
}

/** =========================
 *  Download
 *  ========================= */
function downloadCurrent(){
  if(!current || !current.musicUrl){ toast(t("needPlay")); return; }
  const a = document.createElement("a");
  a.href = current.musicUrl;
  const safeName = `${current.title || "track"} - ${current.singer || "artist"}`.replace(/[\\/:*?"<>|]/g,"_");
  a.download = safeName;
  a.target = "_blank";
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** =========================
 *  Visualizer (WebAudio)
 *  ========================= */
let audioCtx=null, analyser=null, dataArray=null, vizRAF=null;
function setupVisualizer(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = audioCtx.createMediaElementSource(audio);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);

  const canvas = document.getElementById("viz");
  const ctx = canvas.getContext("2d");
  function resize(){
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * devicePixelRatio);
    canvas.height = Math.floor(rect.height * devicePixelRatio);
  }
  resize();
  window.addEventListener("resize", resize);

  const draw=()=>{
    vizRAF = requestAnimationFrame(draw);
    if(!analyser) return;
    analyser.getByteFrequencyData(dataArray);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    const w = canvas.width, h = canvas.height;

    // bars
    const barCount = 96;
    const step = Math.floor(dataArray.length / barCount);
    const barW = w / barCount;

    for(let i=0;i<barCount;i++){
      const v = dataArray[i*step] / 255;
      const bh = v * (h*0.35);
      const x = i*barW;
      const y = h - bh - 10*devicePixelRatio;
      // no fixed colors requirement here is only for matplotlib; web canvas ok.
      const grad = ctx.createLinearGradient(0,y,0,y+bh);
      grad.addColorStop(0, "rgba(167,139,250,.65)");
      grad.addColorStop(0.5,"rgba(250,204,21,.40)");
      grad.addColorStop(1, "rgba(34,211,238,.20)");
      ctx.fillStyle = grad;
      ctx.fillRect(x, y, Math.max(1, barW*0.55), bh);
    }

    // soft glow overlay
    ctx.fillStyle = "rgba(255,255,255,.03)";
    ctx.fillRect(0,0,w,h);
  };
  draw();
}

/** =========================
 *  Modal
 *  ========================= */
function openModal(){
  document.getElementById("modalBackdrop").style.display="flex";
}
function closeModal(){
  document.getElementById("modalBackdrop").style.display="none";
}

/** =========================
 *  Keyboard shortcuts
 *  ========================= */
function inputFocused(){
  const el = document.activeElement;
  if(!el) return false;
  return el.tagName==="INPUT" || el.tagName==="TEXTAREA" || el.isContentEditable;
}

document.addEventListener("keydown",(e)=>{
  if(e.key==="?" && !inputFocused()){
    e.preventDefault();
    openModal();
    return;
  }
  if(inputFocused()) return;

  if(e.key===" "){
    e.preventDefault(); playPause();
  }else if(e.key==="ArrowRight"){
    audio.currentTime = Math.min((audio.duration||0), (audio.currentTime||0)+5);
  }else if(e.key==="ArrowLeft"){
    audio.currentTime = Math.max(0, (audio.currentTime||0)-5);
  }else if(e.key==="ArrowUp"){
    e.preventDefault();
    audio.volume = Math.min(1, audio.volume + 0.05);
    document.getElementById("vol").value = String(Math.round(audio.volume*100));
  }else if(e.key==="ArrowDown"){
    e.preventDefault();
    audio.volume = Math.max(0, audio.volume - 0.05);
    document.getElementById("vol").value = String(Math.round(audio.volume*100));
  }else if(e.key.toLowerCase()==="n"){
    nextTrack();
  }else if(e.key.toLowerCase()==="p"){
    prevTrack();
  }else if(e.key.toLowerCase()==="l"){
    const panel = document.getElementById("lyricsPanel");
    panel.style.display = (panel.style.display==="none") ? "block" : "none";
  }else if(e.key==="/"){
    e.preventDefault();
    document.getElementById("q").focus();
  }else if(e.key.toLowerCase()==="f"){
    toggleFav();
  }else if(e.key.toLowerCase()==="s"){
    downloadCurrent();
  }else if(e.key.toLowerCase()==="t"){
    toggleLang();
  }
});

/** =========================
 *  Events wiring
 *  ========================= */
document.getElementById("btnSearch").addEventListener("click", ()=>doSearch(true));
document.getElementById("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doSearch(true); });

document.getElementById("tabQueue").addEventListener("click",()=>setTab("queue"));
document.getElementById("tabFav").addEventListener("click",()=>setTab("fav"));

document.getElementById("btnNewPlaylist").addEventListener("click", createPlaylist);
document.getElementById("btnAddToPlaylist").addEventListener("click", addCurrentToPlaylist);

document.getElementById("btnFav").addEventListener("click", toggleFav);
document.getElementById("btnDownload").addEventListener("click", downloadCurrent);

document.getElementById("btnPrev").addEventListener("click", prevTrack);
document.getElementById("btnNext").addEventListener("click", nextTrack);
document.getElementById("btnPlay").addEventListener("click", ()=>{
  setupVisualizer();
  if(audioCtx && audioCtx.state==="suspended") audioCtx.resume().catch(()=>{});
  playPause();
});

document.getElementById("vol").addEventListener("input",(e)=>{
  audio.volume = (parseInt(e.target.value,10)||0)/100;
});
audio.volume = 0.75;

document.getElementById("seek").addEventListener("input",(e)=>{
  const v = parseInt(e.target.value,10)||0;
  const dur = audio.duration || 0;
  if(dur>0) audio.currentTime = (v/1000)*dur;
});

audio.addEventListener("timeupdate",()=>{
  document.getElementById("tCur").textContent = fmtTime(audio.currentTime||0);
  document.getElementById("tDur").textContent = fmtTime(audio.duration||0);
  const dur = audio.duration||0;
  if(dur>0){
    document.getElementById("seek").value = String(Math.round((audio.currentTime/dur)*1000));
  }
  // lyric highlight (throttle a bit)
  if(!lyricTimer){
    lyricTimer = setTimeout(()=>{
      updateLyricsHighlight();
      lyricTimer = null;
    }, 400);
  }
});
audio.addEventListener("ended", nextTrack);
audio.addEventListener("play", ()=>{
  document.getElementById("playIcon").className = "fa-solid fa-pause";
});
audio.addEventListener("pause", ()=>{
  document.getElementById("playIcon").className = "fa-solid fa-play";
});

// left results infinite scroll
document.getElementById("results").addEventListener("scroll",(e)=>{
  const el = e.target;
  if(el.scrollTop + el.clientHeight >= el.scrollHeight - 120){
    // near bottom
    const kw = document.getElementById("q").value.trim();
    if(kw) loadMore();
  }
});

// modal
document.getElementById("btnShortcuts").addEventListener("click", openModal);
document.getElementById("btnCloseModal").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click",(e)=>{
  if(e.target.id==="modalBackdrop") closeModal();
});

// lyrics toggle
document.getElementById("btnToggleLyrics").addEventListener("click",()=>{
  const panel = document.getElementById("lyricsPanel");
  panel.style.display = (panel.style.display==="none") ? "block" : "none";
});

function toggleLang(){
  LANG = (LANG==="zh") ? "en" : "zh";
  applyI18n();
  refreshPlaylistSelect();
  renderRightList();
  renderLeftResults();
}
document.getElementById("btnLang").addEventListener("click", toggleLang);

/** =========================
 *  Init
 *  ========================= */
attachRipple();
loadPersist();
applyI18n();

// give a gentle default
document.getElementById("q").value = (LANG==="zh") ? "周杰伦" : "Jay Chou";
</script>
</body>
</html>
